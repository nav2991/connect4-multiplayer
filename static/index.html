<!DOCTYPE html>
<html>
<head>
  <title>Connect 4</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="title-container">
    <h1 class="title"><span class="connect">CONNECT</span> <span class="four">4</span></h1>
  </div>
  <div class="game-wrapper">
    <div class="players-container">
      <div class="player1-box">
        <h2 class="roboto-custom player1-title">Player 1</h2>
      </div>
      <div class="player2-box">
        <h2 class="roboto-custom player2-title">Player 2</h2>
      </div>
    </div>

    <div class="container" id="board"></div>
    
    <div class="play-again-container" id="play-again" style="display: none;">
      <h3 class="play-again-text">Play Again?</h3>
      <div class="play-again-buttons">
        <button class="play-again-btn yes-btn">Yes</button>
        <button class="play-again-btn no-btn" onclick="hidePlayAgain()">No</button>
      </div>
    </div>
  </div>

  <script>
    const board = document.getElementById("board");
    const rows = 6;
    const cols = 7;
    let playerId = null;

    // Build the game board: create 6 rows Ã— 7 columns of cells
    for (let row = 0; row < rows; row++) {
      for (let col = 0; col < cols; col++) {
        const cell = document.createElement("div");
        cell.classList.add("cell");
        cell.dataset.row = row;
        cell.dataset.col = col;

        const circle = document.createElement("div");
        circle.classList.add("circle");

        cell.appendChild(circle);
        board.appendChild(cell);
      }
    }

    const allCells = document.querySelectorAll('.cell');

    // Highlight column on mouseover (preview move)
    allCells.forEach(cell => {
      cell.addEventListener('mouseover', () => {
        const col = cell.dataset.col;

        document.querySelectorAll(`.cell[data-col="${col}"]`)
          .forEach(c => c.classList.add('highlight'));
      });

      cell.addEventListener('mouseout', () => {
        const col = cell.dataset.col;

        document.querySelectorAll(`.cell[data-col="${col}"]`)
          .forEach(c => c.classList.remove('highlight'));
      });

      // Send move to server when a cell is clicked
      cell.addEventListener('click', () => {
        const col = parseInt(cell.dataset.col);
        if (playerId !== null) {
          socket.send(JSON.stringify({
            action: "drop",
            player: playerId,
            column: col
          }));
        }
      });
    });

    const socket = new WebSocket("ws://localhost:8000/ws");

    socket.onopen = () => {
      console.log("ðŸŸ¢ WebSocket connected");
    };

    socket.onmessage = (event) => {
      console.log("ðŸ“© Message from server:", event.data);
      const data = JSON.parse(event.data);

      if (data.player !== undefined) {
        playerId = data.player;
        console.log("ðŸŽ® Assigned player ID:", playerId);
      }

      // Update the board with new disc positions
      if (data.board) {
        const flatCells = document.querySelectorAll('.cell');

        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            const index = row * cols + col;
            const circle = flatCells[index].querySelector('.circle');
            circle.classList.remove('red', 'yellow');

            if (data.board[row][col] === 1) {
              circle.classList.add('red');
            } else if (data.board[row][col] === 2) {
              circle.classList.add('yellow');
            }
          }
        }
      }

      const player1Box = document.querySelector('.player1-box');
      const player2Box = document.querySelector('.player2-box');

      if (data.is_game_over && data.winner !== null) {
        player1Box.classList.remove('flash', 'flash-player1', 'flash-player2');
        player2Box.classList.remove('flash', 'flash-player1', 'flash-player2');
        
        // Add trophy and winner styling
        if (data.winner === 1) {
          if (!player1Box.querySelector('.trophy')) {
            const trophy = document.createElement('div');
            trophy.classList.add('trophy');
            player1Box.appendChild(trophy);
          }
          player1Box.classList.add('winner');
          player2Box.classList.remove('winner');
        } else if (data.winner === 2) {
          if (!player2Box.querySelector('.trophy')) {
            const trophy = document.createElement('div');
            trophy.classList.add('trophy');
            player2Box.appendChild(trophy);
          }
          player2Box.classList.add('winner');
          player1Box.classList.remove('winner');
        }
        
        // Only show play again message if it's not already visible
        if (document.getElementById('play-again').style.display === 'none') {
          document.getElementById('play-again').style.display = 'block';
        }
        
      } else {
        // GAME ACTIVE - Game is still being played
        
        // Show whose turn it is with coloured glow
        if (data.current_player === 1) {
          player1Box.classList.add('flash-player1');
          player2Box.classList.remove('flash-player1', 'flash-player2');
        } else if (data.current_player === 2) {
          player2Box.classList.add('flash-player2');
          player1Box.classList.remove('flash-player1', 'flash-player2');
        }
      }
    };

    socket.onclose = () => {
      console.log("ðŸ”´ WebSocket disconnected");
    };

    function hidePlayAgain() {
      document.getElementById('play-again').style.display = 'none';
    }
  </script>
</body>
</html>